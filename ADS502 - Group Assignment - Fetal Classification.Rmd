---
title: "ADS502 - Group Assignment - Fetal Classification"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### R Libraries
```{r libraries}
library(reshape2)
library(ggplot2)
library(C50)
library(dplyr)
library(randomForest)
library(nnet)
library(NeuralNetTools)
library(rpart)
library(rpart.plot)
library(caret)
library(tidyverse)
```

## Exploratory Data Analysis

In this section, we will explore our data and develop an understanding of the information available to us. Our overall goal is to determine which records in the set may be prone to higher chances of mortality. 

### Read data
```{r dataframes}
## Read full data set
fetal_df <- read.csv(file = '/Volumes/GoogleDrive/My Drive/Masters of Applied Data Sciences/2021 - 2 - Summer/ADS502 - Data Mining/Group Project/fetal_health.csv')
```


### Data Summary, Missing Values and Outliers

As we see below, there are no missing values in this dataset. 

```{r datasummary}
## Count of missing values for each column.
sapply(fetal_df, function(x) sum(is.na(x)))
```

### Histograms
```{r}
hist(fetal_df$baseline.value, 
     main="Histogram for baseline.value", 
     xlab="baseline.value", 
     border="black", 
     col="wheat",
     xlim=c(90,200),
     las=1, 
     breaks=5)
```




### Boxplots
```{r distboxplots}

fetal_df %>%
  ggplot( aes(as.numeric(row.names(fetal_df)), accelerations)) +
    geom_boxplot(color="tomato3", fill="wheat", alpha=0.2) +
    geom_jitter(color="black", size=0.4, alpha=0.35) +
    theme_minimal() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Accelerations Boxplot") +
    xlab("observation no.")
```








### For Modelling Phase; create training and test sets (do this after normalizing data if needed in EDA)
```{r traintest}
## Create train and test sets; to be used later for modelling
## set the seed to make your partition reproducible
set.seed(7)
sample_size = round(nrow(fetal_df)*.80)
index <- sample(seq_len(nrow(fetal_df)), size = sample_size)
 
fetal_train <- fetal_df[index, ]
fetal_test <- fetal_df[-index, ]

```

<<<<<<< Updated upstream
<<<<<<< Updated upstream
=======
#### fetal_health
```{r logreg}
fetal_train$fetal_health <- ordered(as.factor(fetal_train$fetal_health))
logreg01 <- glm(formula = fetal_health ~ prolongued_decelerations + abnormal_short_term_variability + percentage_of_time_with_abnormal_long_term_variability + accelerations + histogram_mode + mean_value_of_long_term_variability + histogram_variance + uterine_contractions, data = fetal_train, family = binomial)
summary(logreg01)
```
>>>>>>> Stashed changes
=======

##fetal_health logistic regression
```{r logreg}
library(nnet)
train_fetal_rebal$fetal_health <- ordered(as.factor(train_fetal_rebal$fetal_health))
logreg02 <- multinom(fetal_health ~ prolongued_decelerations + abnormal_short_term_variability + percentage_of_time_with_abnormal_long_term_variability + accelerations + histogram_mode + mean_value_of_long_term_variability + histogram_variance + uterine_contractions, data = train_fetal_rebal)


#changed to fetal test
#Let Aubrey know
fetal_train$fetal_health <- ordered(as.factor(fetal_train$fetal_health))
#Predict using test set
lpred <- predict(logreg02, fetal_test, type = 'class')
table(fetal_test$fetal_health, lpred)


confusionMatrix(lpred, factor(fetal_test$fetal_health))
```


```{r}

#KNN
library(class)

#need to normalize the data first

#function to normalize
data_norm <- function(x) {((x - min(x)) / (max(x) - min(x)))}

#normalizing training and testing data
fetal_train_norm <- as.data.frame(lapply(fetal_train, data_norm))
fetal_test_norm <- as.data.frame(lapply(fetal_test, data_norm))

#getting our target variable
colnames(fetal_train)


fetal_train_labels <- fetal_train[1:fetal_train_dim[1], 9]
fetal_test_labels <- fetal_test[1:fetal_test_dim[1], 9]


#k gets decided based on the squareroot of data points
#training dataset has 1642 variables. Therefore k is around 40

#predicts labels with actual labels
fetal_pred <- knn(fetal_train_norm, fetal_test_norm, fetal_train_labels, k = 40)
table(fetal_pred, fetal_test_labels)

#diagonals are correcly classified
#triangles are incorrectly classified
#predicted a 2 incorrectly 2 times as a 1





```
```{r}

#Decision Tree Models

#CART model
library(rpart)
library(rpart.plot)

#using rpart to run our CART model

fetal_train$fetal_health <- factor(fetal_train$fetal_health)
fetal_test$fetal_health <- factor(fetal_test$fetal_health)


cart01_fetal_train <- rpart(formula = fetal_health ~ prolongued_decelerations + abnormal_short_term_variability + percentage_of_time_with_abnormal_long_term_variability + accelerations + histogram_mode + mean_value_of_long_term_variability + histogram_variance +uterine_contractions, data = fetal_train)

rpart.plot(cart01_fetal_train, type = 4, extra = 2)

#to obtain classifications for each record, first we will create a dataframe with the predictor vars of the records we wish to classify

library(caret)

X_fetal_test_cart = data.frame(prolongued_decelerations = fetal_test$prolongued_decelerations, abnormal_short_term_variability = fetal_test$abnormal_short_term_variability,percentage_of_time_with_abnormal_long_term_variability = fetal_test$percentage_of_time_with_abnormal_long_term_variability, accelerations = fetal_test$accelerations, histogram_mode = fetal_test$histogram_mode, mean_value_of_long_term_variability = fetal_test$mean_value_of_long_term_variability, histogram_variance = fetal_test$histogram_variance, uterine_contractions = fetal_test$uterine_contractions, fetal_health =fetal_test$fetal_health )


#plotting our testing model
rpart.plot(cart01_fetal_test, type = 4, extra = 2)

#predict with test
fetal_predCart <- predict(object = cart01_fetal_train, newdata = X_fetal_test_cart, type = "class")

#table
table_CART <- table(fetal_test$fetal_health, fetal_predCart)
table_CART


```
```{r}
#C5 Model
library(C50)
library(partykit)

#running C5 algorithm

C5_fetal <- C5.0(formula = fetal_health ~ prolongued_decelerations + abnormal_short_term_variability + percentage_of_time_with_abnormal_long_term_variability + accelerations + histogram_mode + mean_value_of_long_term_variability + histogram_variance +uterine_contractions, data = fetal_train, control = C5.0Control(minCases = 75))

plot(C5_fetal, gp = gpar(fontsize = 8))

fetal_pred_C5 <- predict(object = C5_fetal, newdata = X_fetal_test_cart)

#Table to evaluate model

table_C5 <- table(fetal_test$fetal_health, fetal_pred_C5 )
table_C5


```


```{r}

#Random Forest Model
library(randomForest)

random_Fetal <- randomForest(formula = fetal_health ~ prolongued_decelerations + abnormal_short_term_variability + percentage_of_time_with_abnormal_long_term_variability + accelerations + histogram_mode + mean_value_of_long_term_variability + histogram_variance +uterine_contractions, data = fetal_train, ntree = 100, type = "classification")

#predict

fetal_random_pred <- predict(object = random_Fetal, X_fetal_test_cart)

table_RF <- table(fetal_test$fetal_health, fetal_random_pred)

table_RF




```



```{r naivebayes}
#install.packages("e1071")
library(e1071)
cols = c('prolongued_decelerations', 'abnormal_short_term_variability', 'percentage_of_time_with_abnormal_long_term_variability', 'accelerations', 'histogram_mode', 'mean_value_of_long_term_variability', 'histogram_variance', 'uterine_contractions','fetal_health')
train_fetal_rebal[, cols] <- lapply(train_fetal_rebal[, cols], as.factor)
nb01 <- naiveBayes(formula = fetal_health ~ prolongued_decelerations + abnormal_short_term_variability + percentage_of_time_with_abnormal_long_term_variability + accelerations + histogram_mode + mean_value_of_long_term_variability + histogram_variance + uterine_contractions, data = train_fetal_rebal)
nb01
fetal_test[, cols] <- lapply(fetal_test[, cols], as.factor)
ypred <- predict(object = nb01, newdata = fetal_test)
t.preds <- table(fetal_test$fetal_health, ypred)
colnames(t.preds) <- c("Actual: 1", "Actual: 2", "Actual: 3")
rownames(t.preds) <- c("Predicted: 1", "Predicted: 2", "Predicted: 3   ")
addmargins(A = t.preds, FUN = list(Total = sum), quiet = TRUE)
```
##The A‐priori probabilities are the values of p(Y)
### p(1) = .715
### p(2) = .134
### p(3) = .15
```{r nb2}
#install.packages('caret', dependencies = T)
library(caret)
fetal_test[, cols] <- lapply(fetal_test[, cols], as.factor)
predictions <- predict(nb01, fetal_test)
confusionMatrix(predictions, fetal_test[, 'fetal_health'], positive='yes')
```

>>>>>>> Stashed changes
